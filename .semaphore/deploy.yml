version: v1.0

name: "Deploy"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: google-cloud-platform

blocks:

  - name: "Deploy Relay Binary"

    task:

      prologue:
        commands:
            - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json

      jobs:

        - name: "relay"
          commands:
            - artifact pull workflow relay
            - chmod +x relay
            - export VERSION=`./relay version`
            - mv relay relay-$VERSION
            - gsutil cp relay-$VERSION gs://relay_artifacts/
