version: v1.0

name: Test

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: sdk5-repo-access

blocks:

  - name: "Dependencies"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Build Sodium and ZeroMQ"
          commands:
            
            - checkout

            - cd ~/backend/libs/sodium
            - ./configure
            - make -j32
            - sudo make -j32 install
            - sudo ldconfig
            - artifact push workflow /usr/local/lib/libsodium.so

            - cd ~/backend/libs/zeromq
            - ./autogen.sh
            - ./configure --with-norm=no --with-pgm=no
            - make -j32
            - sudo make -j32 install
            - sudo ldconfig
            - artifact push workflow /usr/local/lib/libzmq.so

  - name: "Backend"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:

            - checkout
            - cp envs/local.env .env
            - sudo apt-get install -y libsodium-dev

            - cd ~/backend/libs/zeromq
            - ./autogen.sh
            - ./configure --with-norm=no --with-pgm=no
            - make -j32
            - sudo make -j32 install
            - sudo ldconfig

            - cd ~/backend
            - make test
            - cache store

  - name: "SDK4"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get install -y libsodium-dev
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - checkout
            - cp envs/local.env .env
            - git submodule init
            - git submodule update
            - export LD_LIBRARY_PATH=. && make -j32 test-sdk4

  - name: "SDK5"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get install -y libsodium-dev
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - checkout
            - cp envs/local.env .env
            - git submodule init
            - git submodule update
            - export LD_LIBRARY_PATH=. && make -j32 test-sdk5

  - name: "Relay"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - cp envs/local.env .env
            - make -j32 test-relay
            - artifact push workflow ./dist/reference_relay

  - name: "Build Functional Tests 4"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - git submodule init
            - git submodule update

            - cd ~/backend/libs/zeromq
            - ./autogen.sh
            - ./configure --with-norm=no --with-pgm=no
            - make -j32
            - sudo make -j32 install
            - sudo ldconfig

            - cd ~/backend
            - make -j32 build-test-func4

            - mv dist/reference_relay dist/reference_relay4
            - artifact push workflow dist/func_client4
            - artifact push workflow dist/func_server4
            - artifact push workflow dist/func_backend4
            - artifact push workflow dist/func_tests4
            - artifact push workflow dist/reference_relay4
            - artifact push workflow dist/libnext4.so

  - name: "Run Functional Tests 4"
    dependencies: ["Build Functional Tests 4", "Dependencies"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_client4
            - artifact pull workflow func_server4
            - artifact pull workflow func_backend4
            - artifact pull workflow func_tests4
            - artifact pull workflow reference_relay4
            - artifact pull workflow libnext4.so
            - artifact pull workflow libsodium.so
            - artifact pull workflow libzmq.so

            - chmod +x func_client4
            - chmod +x func_server4
            - chmod +x func_backend4
            - chmod +x func_tests4
            - chmod +x reference_relay4
            - chmod +x libnext4.so
            - chmod +x libsodium.so
            - chmod +x libzmq.so

            - sudo mv libsodium.so /usr/local/lib
            - sudo mv libzmq.so /usr/local/lib
            - sudo mv libnext4.so /usr/local/lib
            - sudo ldconfig

            - mv reference_relay4 reference_relay

            - cd ~

      jobs:

        - name: "test_direct_raw"
          commands:
            - cd ./dist && ./func_tests4 test_direct_raw

        - name: "test_direct_upgraded"
          commands:
            - cd ./dist && ./func_tests4 test_direct_upgraded

        - name: "test_network_next_route"
          commands:
            - cd ./dist && ./func_tests4 test_network_next_route

        - name: "test_fallback_to_direct_backend"
          commands:
            - cd ./dist && ./func_tests4 test_fallback_to_direct_backend

        - name: "test_fallback_to_direct_client_side"
          commands:
            - cd ./dist && ./func_tests4 test_fallback_to_direct_client_side

        - name: "test_fallback_to_direct_server_restart"
          commands:
            - cd ./dist && ./func_tests4 test_fallback_to_direct_server_restart

        - name: "test_disable_on_server"
          commands:
            - cd ./dist && ./func_tests4 test_disable_on_server

        - name: "test_disable_on_client"
          commands:
            - cd ./dist && ./func_tests4 test_disable_on_client

        - name: "test_route_switching"
          commands:
            - cd ./dist && ./func_tests4 test_route_switching

        - name: "test_on_off"
          commands:
            - cd ./dist && ./func_tests4 test_on_off

        - name: "test_on_on_off"
          commands:
            - cd ./dist && ./func_tests4 test_on_on_off

        - name: "test_reconnect_direct"
          commands:
            - cd ./dist && ./func_tests4 test_reconnect_direct

        - name: "test_reconnect_direct_no_upgrade"
          commands:
            - cd ./dist && ./func_tests4 test_reconnect_direct_no_upgrade

        - name: "test_reconnect_next"
          commands:
            - cd ./dist && ./func_tests4 test_reconnect_next

        - name: "test_connect_to_another_server_direct"
          commands:
            - cd ./dist && ./func_tests4 test_connect_to_another_server_direct

        - name: "test_connect_to_another_server_next"
          commands:
            - cd ./dist && ./func_tests4 test_connect_to_another_server_next

        - name: "test_multipath"
          commands:
            - cd ./dist && ./func_tests4 test_multipath

        - name: "test_multipath_next_packet_loss"
          commands:
            - cd ./dist && ./func_tests4 test_multipath_next_packet_loss

        - name: "test_multipath_fallback_to_direct"
          commands:
            - cd ./dist && ./func_tests4 test_multipath_fallback_to_direct

        - name: "test_uncommitted"
          commands:
            - cd ./dist && ./func_tests4 test_uncommitted

        - name: "test_uncommitted_to_committed"
          commands:
            - cd ./dist && ./func_tests4 test_uncommitted_to_committed

        - name: "test_packet_loss_direct"
          commands:
            - cd ./dist && ./func_tests4 test_packet_loss_direct

        - name: "test_packet_loss_next"
          commands:
            - cd ./dist && ./func_tests4 test_packet_loss_next

        - name: "test_server_under_load"
          commands:
            - cd ./dist && ./func_tests4 test_server_under_load

        - name: "test_session_update_retry"
          commands:
            - cd ./dist && ./func_tests4 test_session_update_retry

        - name: "test_bandwidth_over_limit"
          commands:
            - cd ./dist && ./func_tests4 test_bandwidth_over_limit

        - name: "test_packet_loss"
          commands:
            - cd ./dist && ./func_tests4 test_packet_loss

        - name: "test_bandwidth"
          commands:
            - cd ./dist && ./func_tests4 test_bandwidth

        - name: "test_jitter"
          commands:
            - cd ./dist && ./func_tests4 test_jitter

        - name: "test_tags"
          commands:
            - cd ./dist && ./func_tests4 test_tags

        - name: "test_tags_multi"
          commands:
            - cd ./dist && ./func_tests4 test_tags_multi

        - name: "test_direct_stats"
          commands:
            - cd ./dist && ./func_tests4 test_direct_stats

        - name: "test_next_stats"
          commands:
            - cd ./dist && ./func_tests4 test_next_stats

        - name: "test_report_session"
          commands:
            - cd ./dist && ./func_tests4 test_report_session

        - name: "test_client_ping_timed_out"
          commands:
            - cd ./dist && ./func_tests4 test_client_ping_timed_out

        - name: "test_server_events"
          commands:
            - cd ./dist && ./func_tests4 test_server_events

        - name: "test_match_id"
          commands:
            - cd ./dist && ./func_tests4 test_match_id

        - name: "test_match_values"
          commands:
            - cd ./dist && ./func_tests4 test_match_values

        - name: "test_match_data_retry"
          commands:
            - cd ./dist && ./func_tests4 test_match_data_retry

        - name: "test_flush"
          commands:
            - cd ./dist && ./func_tests4 test_flush

        - name: "test_flush_retry"
          commands:
            - cd ./dist && ./func_tests4 test_flush_retry

        - name: "test_flush_server_events_and_match_data"
          commands:
            - cd ./dist && ./func_tests4 test_flush_server_events_and_match_data

        - name: "test_flush_server_events_and_match_data_retry"
          commands:
            - cd ./dist && ./func_tests4 test_flush_server_events_and_match_data_retry


  - name: "Build Functional Tests 5"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env
            - chmod 0600 /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - ssh-add /home/semaphore/.ssh/id_rsa_semaphoreci_sdk5
            - git submodule init
            - git submodule update

            - cd ~/backend/libs/zeromq
            - ./autogen.sh
            - ./configure --with-norm=no --with-pgm=no
            - make -j32
            - sudo make -j32 install
            - sudo ldconfig

            - cd ~/backend
            - make -j32 build-test-func5

            - mv dist/reference_relay dist/reference_relay5
            - artifact push workflow dist/func_client5
            - artifact push workflow dist/func_server5
            - artifact push workflow dist/func_backend5
            - artifact push workflow dist/func_tests5
            - artifact push workflow dist/reference_relay5
            - artifact push workflow dist/libnext5.so


  - name: "Run Functional Tests 5a"
    dependencies: ["Build Functional Tests 5"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_client5
            - artifact pull workflow func_server5
            - artifact pull workflow func_backend5
            - artifact pull workflow func_tests5
            - artifact pull workflow reference_relay5
            - artifact pull workflow libnext5.so
            - artifact pull workflow libsodium.so
            - artifact pull workflow libzmq.so

            - chmod +x func_client5
            - chmod +x func_server5
            - chmod +x func_backend5
            - chmod +x func_tests5
            - chmod +x reference_relay5
            - chmod +x libnext5.so
            - chmod +x libsodium.so
            - chmod +x libzmq.so

            - sudo mv libsodium.so /usr/local/lib
            - sudo mv libzmq.so /usr/local/lib
            - sudo mv libnext5.so /usr/local/lib
            - sudo ldconfig

            - mv reference_relay5 reference_relay

            - cd ~

      jobs:

        - name: "test_passthrough"
          commands:
            - cd ./dist && ./func_tests5 test_passthrough

        - name: "test_direct_upgraded"
          commands:
            - cd ./dist && ./func_tests5 test_direct_upgraded

        - name: "test_network_next_route"
          commands:
            - cd ./dist && ./func_tests5 test_network_next_route

        - name: "test_fallback_to_direct_backend"
          commands:
            - cd ./dist && ./func_tests5 test_fallback_to_direct_backend

        - name: "test_fallback_to_direct_client_side"
          commands:
            - cd ./dist && ./func_tests5 test_fallback_to_direct_client_side

        - name: "test_fallback_to_direct_server_restart"
          commands:
            - cd ./dist && ./func_tests5 test_fallback_to_direct_server_restart

        - name: "test_disable_on_server"
          commands:
            - cd ./dist && ./func_tests5 test_disable_on_server

        - name: "test_disable_on_client"
          commands:
            - cd ./dist && ./func_tests5 test_disable_on_client

        - name: "test_route_switching"
          commands:
            - cd ./dist && ./func_tests5 test_route_switching

        - name: "test_on_off"
          commands:
            - cd ./dist && ./func_tests5 test_on_off

        - name: "test_on_on_off"
          commands:
            - cd ./dist && ./func_tests5 test_on_on_off

        - name: "test_reconnect_direct"
          commands:
            - cd ./dist && ./func_tests5 test_reconnect_direct

        - name: "test_reconnect_direct_no_upgrade"
          commands:
            - cd ./dist && ./func_tests5 test_reconnect_direct_no_upgrade

        - name: "test_reconnect_next"
          commands:
            - cd ./dist && ./func_tests5 test_reconnect_next

        - name: "test_connect_to_another_server_direct"
          commands:
            - cd ./dist && ./func_tests5 test_connect_to_another_server_direct

        - name: "test_connect_to_another_server_next"
          commands:
            - cd ./dist && ./func_tests5 test_connect_to_another_server_next

        - name: "test_multipath"
          commands:
            - cd ./dist && ./func_tests5 test_multipath

        - name: "test_multipath_next_packet_loss"
          commands:
            - cd ./dist && ./func_tests5 test_multipath_next_packet_loss

        - name: "test_multipath_fallback_to_direct"
          commands:
            - cd ./dist && ./func_tests5 test_multipath_fallback_to_direct

        - name: "test_uncommitted"
          commands:
            - cd ./dist && ./func_tests5 test_uncommitted_to_committed

        - name: "test_packet_loss_direct"
          commands:
            - cd ./dist && ./func_tests5 test_packet_loss_direct

        - name: "test_packet_loss_next"
          commands:
            - cd ./dist && ./func_tests5 test_packet_loss_next

        - name: "test_server_under_load"
          commands:
            - cd ./dist && ./func_tests5 test_server_under_load

        - name: "test_session_update_retry"
          commands:
            - cd ./dist && ./func_tests5 test_session_update_retry

        - name: "test_bandwidth_over_limit"
          commands:
            - cd ./dist && ./func_tests5 test_bandwidth_over_limit

        - name: "test_packet_loss"
          commands:
            - cd ./dist && ./func_tests5 test_packet_loss

        - name: "test_bandwidth"
          commands:
            - cd ./dist && ./func_tests5 test_bandwidth

        - name: "test_jitter"
          commands:
            - cd ./dist && ./func_tests5 test_jitter

        - name: "test_tags"
          commands:
            - cd ./dist && ./func_tests5 test_tags

        - name: "test_tags_multi"
          commands:
            - cd ./dist && ./func_tests5 test_tags_multi

        - name: "test_direct_stats"
          commands:
            - cd ./dist && ./func_tests5 test_direct_stats

        - name: "test_next_stats"
          commands:
            - cd ./dist && ./func_tests5 test_next_stats

        - name: "test_report_session"
          commands:
            - cd ./dist && ./func_tests5 test_report_session

        - name: "test_client_ping_timed_out"
          commands:
            - cd ./dist && ./func_tests5 test_client_ping_timed_out

        - name: "test_server_ready_success"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_success

        - name: "test_server_ready_fallback_to_direct"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_fallback_to_direct

        - name: "test_server_ready_autodetect_cloud"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_autodetect_cloud

        - name: "test_server_ready_autodetect_multiplay_success"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_autodetect_multiplay_success

        - name: "test_server_ready_autodetect_multiplay_fail"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_autodetect_multiplay_fail

        - name: "test_server_ready_disable_autodetect_cloud"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_disable_autodetect_cloud

        - name: "test_server_ready_disable_autodetect_multiplay"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_disable_autodetect_multiplay

        - name: "test_server_ready_resolve_hostname_timeout"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_resolve_hostname_timeout

        - name: "test_server_ready_autodetect_timeout"
          commands:
            - cd ./dist && ./func_tests5 test_server_ready_resolve_hostname_timeout

        - name: "test_client_connect_before_ready"
          commands:
            - cd ./dist && ./func_tests5 test_client_connect_before_ready

        - name: "test_server_events"
          commands:
            - cd ./dist && ./func_tests5 test_server_events

        - name: "test_match_id"
          commands:
            - cd ./dist && ./func_tests5 test_match_id

        - name: "test_match_values"
          commands:
            - cd ./dist && ./func_tests5 test_match_values

        - name: "test_match_data_retry"
          commands:
            - cd ./dist && ./func_tests5 test_match_data_retry

        - name: "test_flush"
          commands:
            - cd ./dist && ./func_tests5 test_flush

        - name: "test_flush_retry"
          commands:
            - cd ./dist && ./func_tests5 test_flush_retry

  - name: "Run Functional Tests 5b"
    dependencies: ["Build Functional Tests 5"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_client5
            - artifact pull workflow func_server5
            - artifact pull workflow func_backend5
            - artifact pull workflow func_tests5
            - artifact pull workflow reference_relay5
            - artifact pull workflow libnext5.so
            - artifact pull workflow libsodium.so
            - artifact pull workflow libzmq.so

            - chmod +x func_client5
            - chmod +x func_server5
            - chmod +x func_backend5
            - chmod +x func_tests5
            - chmod +x reference_relay5
            - chmod +x libnext5.so
            - chmod +x libsodium.so
            - chmod +x libzmq.so

            - sudo mv libsodium.so /usr/local/lib
            - sudo mv libzmq.so /usr/local/lib
            - sudo mv libnext5.so /usr/local/lib
            - sudo ldconfig

            - mv reference_relay5 reference_relay

            - cd ~

      jobs:

        - name: "test_flush_server_events_and_match_data"
          commands:
            - cd ./dist && ./func_tests5 test_flush_server_events_and_match_data

        - name: "test_flush_server_events_and_match_data_retry"
          commands:
            - cd ./dist && ./func_tests5 test_flush_server_events_and_match_data_retry

promotions:

  - name: "Development Deployment"
    pipeline_file: development-deploy.yml
    auto_promote:
      when: branch = 'dev' AND result = 'passed'
  
  - name: "Staging Deployment"
    pipeline_file: staging-deploy.yml
    auto_promote:
      when: branch = 'staging' AND result = 'passed'
  
  - name: "Production Deployment"
    pipeline_file: production-deploy.yml
    auto_promote:
      when: branch = 'prod' AND result = 'passed'
  
  - name: "Production Debug Deployment"
    pipeline_file: production-debug-deploy.yml
    auto_promote:
      when: branch = 'prod_debug' AND result = 'passed'