version: v1.0
name: Test
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804
global_job_config:
  secrets:
    - name: sdk4-repo-access
  prologue:
    commands:
      - sudo apt-get update && sudo apt-get -y install libsodium-dev google-cloud-sdk-firestore-emulator google-cloud-sdk-pubsub-emulator google-cloud-sdk-bigtable-emulator libzmq3-dev
      - checkout
      - sem-version go 1.13
      - make clean
      - chmod 0600 ~/.ssh/id_rsa_semaphoreci_sdk4
      - ssh-add ~/.ssh/id_rsa_semaphoreci_sdk4
      - git submodule init sdk4
      - git submodule update sdk4
blocks:
  - name: Unit Tests
    task:
      jobs:
        - name: Backend
          commands:
            - make test
      env_vars:
        - name: FIRESTORE_EMULATOR_HOST
          value: "127.0.0.1:11000"
        - name: PUBSUB_EMULATOR_HOST
          value: "127.0.0.1:12000"
        - name: BIGTABLE_EMULATOR_HOST
          value: "127.0.0.1:8086"
promotions:
  - name: Development Deployment
    pipeline_file: development-deploy.yml
    auto_promote:
      when: branch = 'dev' AND result = 'passed'
  - name: Staging Deployment
    pipeline_file: staging-deploy.yml
    auto_promote:
      when: branch = 'staging' AND result = 'passed'
  - name: Production Deployment
    pipeline_file: production-deploy.yml
    auto_promote:
      when: branch = 'prod' AND result = 'passed'
  - name: Production Debug Deployment
    pipeline_file: production-debug-deploy.yml
    auto_promote:
      when: branch = 'prod_debug' AND result = 'passed'
