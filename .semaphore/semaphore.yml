version: v1.0
name: Test
agent:
  machine:
    type: e1-standard-8
  containers:
    - name: backend
      image: us.gcr.io/network-next-v3-prod/backend
  image_pull_secrets:
    - name: gcr-pull-secrets
blocks:
  - name: Backend Unit Tests
    task:
      jobs:
        - name: Backend
          commands:
            - make test-unit-backend
      env_vars:
        - name: FIRESTORE_EMULATOR_HOST
          value: "127.0.0.1:11000"
        - name: PUBSUB_EMULATOR_HOST
          value: "127.0.0.1:12000"
promotions:
  - name: Development Deployment
    pipeline_file: development-deploy.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed'
  - name: Production Deployment
    pipeline_file: production-deploy.yml
    auto_promote:
      when: "tag =~ '^PROD-(\\d{8})-(.+)' AND result = 'passed'"
