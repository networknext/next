version: v1.0

name: Build

fail_fast:
  stop:
    when: "true"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Components"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Build Components"
          commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - mkdir dist
            - make -j ./dist/relay ./dist/libnext5.so
            - artifact push workflow ./dist/relay
            - artifact push workflow ./dist/libnext5.so
            - artifact push workflow deploy/bootstrap.sh

  - name: "Backend"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - cache restore golang
            - checkout
            - cp envs/local.env .env
            - sudo apt-get install -y libsodium-dev
            - go test ./modules/...

  - name: "SDK5"
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004
      jobs:
        - name: "Unit Tests"
          commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - cp envs/local.env .env
            - export LD_LIBRARY_PATH=.
            - mkdir dist
            - make dist/test
            - cd dist && ./test

  - name: "Build Artifacts (Golang)"

    dependencies: []

    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      prologue:
        commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - cache restore golang

      jobs:

        - name: "Analytics"
          commands:
            - make dist/analytics.dev.tar.gz
            - artifact push workflow dist/analytics.dev.tar.gz

        - name: "API"
          commands:
            - make dist/api.dev.tar.gz
            - artifact push workflow dist/api.dev.tar.gz

        - name: "Map Cruncher"
          commands:
            - make dist/map_cruncher.dev.tar.gz
            - artifact push workflow dist/map_cruncher.dev.tar.gz

        - name: "Portal Cruncher"
          commands:
            - make dist/portal_cruncher.dev.tar.gz
            - artifact push workflow dist/portal_cruncher.dev.tar.gz

        - name: "Relay Gateway"
          commands:
            - make dist/relay_gateway.dev.tar.gz
            - artifact push workflow dist/relay_gateway.dev.tar.gz

        - name: "Relay Backend"
          commands:
            - make dist/relay_backend.dev.tar.gz
            - artifact push workflow dist/relay_backend.dev.tar.gz

        - name: "Server Backend"
          commands:
            - make dist/server_backend.dev.tar.gz
            - artifact push workflow dist/server_backend.dev.tar.gz

        - name: "Magic Backend"
          commands:
            - make dist/magic_backend.dev.tar.gz
            - artifact push workflow dist/magic_backend.dev.tar.gz

        - name: "Raspberry Backend"
          commands:
            - make dist/raspberry_backend.dev.tar.gz
            - artifact push workflow dist/raspberry_backend.dev.tar.gz

  - name: "Build Artifacts (Native)"

    dependencies: []

    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      prologue:
        commands:
            - sudo apt-get install -y libsodium-dev
            - checkout
            - mkdir dist

      jobs:

        - name: "Raspberry Server"
          commands:
            - make -j dist/raspberry_server.dev.tar.gz
            - artifact push workflow dist/raspberry_server.dev.tar.gz

        - name: "Raspberry Client"
          commands:
            - make -j dist/raspberry_client.dev.tar.gz
            - artifact push workflow dist/raspberry_client.dev.tar.gz

promotions:

  - name: "Development Deployment"
    pipeline_file: development-deploy.yml

  - name: "Functional Test Backend"
    pipeline_file: functional-test-backend.yml

  - name: "Functional Test SDK5"
    pipeline_file: functional-test-sdk5.yml

  - name: "Functional Test API"
    pipeline_file: functional-test-api.yml

  - name: "Functional Test Portal"
    pipeline_file: functional-test-portal.yml

  - name: "Functional Test Database"
    pipeline_file: functional-test-database.yml

  - name: "Load Tests"
    pipeline_file: load-tests.yml

  - name: "Happy Path"
    pipeline_file: happy-path.yml

  - name: "Update Golang Cache"
    pipeline_file: update-golang-cache.yml
