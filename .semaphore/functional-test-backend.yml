version: v1.0

name: Functional Test Backend

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:

  - name: "Build Functional Tests (backend)"
    dependencies: []
    task:

      agent:
        machine:
          type: e1-standard-8
          os_image: ubuntu2004

      jobs:
        - name: "Build"
          commands:

            - cache restore golang

            - sudo apt-get install -y libsodium-dev

            - checkout
            - cp envs/local.env .env

            - make clean
            - make -j dist/func_test_backend dist/magic_backend dist/relay_gateway dist/relay_backend

            - artifact push workflow dist/func_test_backend
            - artifact push workflow dist/magic_backend
            - artifact push workflow dist/relay_gateway
            - artifact push workflow dist/relay_backend

  - name: "Run Functional Tests (backend)"
    dependencies: ["Build Functional Tests (backend)"]
    task:

      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu2004

      prologue:
        commands:

            - sudo apt-get install -y libsodium-dev google-cloud-sdk-pubsub-emulator redis-server

            - wget https://github.com/goccy/bigquery-emulator/releases/download/v0.1.12/bigquery-emulator-linux-amd64
            - sudo mv bigquery-emulator-linux-amd64 /usr/local/bin/bigquery-emulator
            - sudo chmod +x /usr/local/bin/bigquery-emulator

            - mkdir -p dist
            - cd dist

            - artifact pull workflow func_test_backend
            - artifact pull workflow magic_backend
            - artifact pull workflow relay_gateway
            - artifact pull workflow relay_backend

            - chmod +x func_test_backend
            - chmod +x magic_backend
            - chmod +x relay_gateway
            - chmod +x relay_backend

            - cd ~

      jobs:

        - name: "test_magic_backend"
          commands:
            - cd ./dist && ./func_test_backend test_magic_backend

        - name: "test_redis_streams"
          commands:
            - cd ./dist && ./func_test_backend test_redis_streams

        - name: "test_redis_pubsub"
          commands:
            - cd ./dist && ./func_test_backend test_redis_pubsub

        - name: "test_google_pubsub"
          commands:
            - gcloud beta emulators pubsub start --project=local --host-port=127.0.0.1:9000 &
            - cd ./dist && ./func_test_backend test_google_pubsub

        - name: "test_google_bigquery"
          commands:
            - bigquery-emulator --project="local" --dataset="local" &
            - cd ./dist && ./func_test_backend test_google_bigquery

        - name: "test_redis_leader_store_no_flap"
          commands:
            - cd ./dist && ./func_test_backend test_redis_leader_store_no_flap

        - name: "test_redis_leader_store_migration"
          commands:
            - cd ./dist && ./func_test_backend test_redis_leader_store_migration

        - name: "test_cost_matrix_read_write"
          commands:
            - cd ./dist && ./func_test_backend test_cost_matrix_read_write

        - name: "test_route_matrix_read_write"
          commands:
            - cd ./dist && ./func_test_backend test_route_matrix_read_write

        - name: "test_session_data_serialize"
          commands:
            - cd ./dist && ./func_test_backend test_session_data_serialize

        - name: "test_relay_manager"
          commands:
            - cd ./dist && ./func_test_backend test_relay_manager

        - name: "test_optimize"
          commands:
            - cd ./dist && ./func_test_backend test_optimize

        - name: "test_relay_backend"
          commands:
            - cd ./dist && ./func_test_backend test_relay_backend
