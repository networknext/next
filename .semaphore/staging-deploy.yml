version: v1.0
name: Staging Deploy
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804
global_job_config:
  secrets:
    - name: sdk4-repo-access
  prologue:
    commands:
      - sudo apt-get update && sudo apt-get -y install libzmq3-dev gcc-8
      - gcloud auth activate-service-account --key-file=/home/semaphore/gcp-service-account.json
      - gcloud auth configure-docker -q
      - checkout
      - sem-version go 1.13
      - make clean
      - chmod 0600 ~/.ssh/id_rsa_semaphoreci_sdk4
      - ssh-add ~/.ssh/id_rsa_semaphoreci_sdk4
      - git submodule init sdk
      - git submodule update sdk
      
      # libsodium in apt is too old, build from source
      - curl https://download.libsodium.org/libsodium/releases/libsodium-1.0.17.tar.gz --output libsodium-1.0.17.tar.gz
      - tar -zxvf libsodium-1.0.17.tar.gz
      - cd ./libsodium-1.0.17
      - ./configure
      - make && make check
      - sudo make install
      - cd ../
blocks:
  - name: Build & Publish Artifacts
    dependencies: []
    task:
      jobs:
        - name: Billing
          commands:
            - make build-billing-artifacts-staging
            - make publish-billing-artifacts-staging
        - name: Analytics
          commands:
            - make build-analytics-artifacts-staging
            - make publish-analytics-artifacts-staging
        - name: Portal
          commands:
            - make build-portal-artifacts-staging
            - make publish-portal-artifacts-staging
        - name: Portal Cruncher
          commands:
            - make build-portal-cruncher-artifacts-staging
            - make publish-portal-cruncher-artifacts-staging
        - name: Relay Backend
          commands:
            - make build-relay-backend-artifacts-staging
            - make publish-relay-backend-artifacts-staging
        - name: Server Backend
          commands:
            - make build-server-backend-artifacts-staging
            - make publish-server-backend-artifacts-staging
        - name: Load Test
          commands:
            - make build-load-test-artifacts-staging
            - make publish-load-test-artifacts-staging
        - name: Load Test Server
          commands:
            - make build-load-test-server-artifacts
            - make publish-load-test-server-artifacts
        - name: Load Test Client
          commands:
            - make build-load-test-client-artifacts
            - make publish-load-test-client-artifacts
        - name: Load Test Server 4
          commands:
            - make build-load-test-server4-artifacts
            - make publish-load-test-server4-artifacts
        - name: Load Test Client 4
          commands:
            - make build-load-test-client4-artifacts
            - make publish-load-test-client4-artifacts
        - name: Bootstrap Script
          commands:
            - make publish-bootstrap-script-staging
        - name: Client Bootstrap Script
          commands:
            - make publish-client-bootstrap-script-staging
        - name: Ghost Army
          commands:
            - make build-ghost-army-artifacts-staging
            - make publish-ghost-army-artifacts-staging
            - make publish-ghost-army-bootstrap-script-staging
      secrets:
        - name: google-cloud-platform-staging
