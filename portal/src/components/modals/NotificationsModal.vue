<template>
  <BaseModal ref="baseModal" :showHeader="true">
    <template v-slot:header>
      <div class="banner d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
        <div class="banner-message">
          Account Notifications
        </div>
      </div>
    </template>
    <template v-slot:body>
      <div class="card" v-for="(notification, index) in releaseNotesNotifications" :key="`release-notes-notification-${index}`" style="margin-top: 20px;text-align: center;">
        <div class="card-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center" >
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            {{ notification.title }}
          </div>
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-left"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#release-notes-notification-${index}`"
            />
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-down"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#release-notes-notification-${index}`"
            />
          </div>
        </div>
        <div class="collapse collapse-release-notes" :id="`release-notes-notification-${index}`">
          <div class="card-body" style="padding-bottom: calc(1.25rem - 16px);">
            <GistEmbed :cssURL="notification.css_url" :embedHTML="notification.embed_html"/>
          </div>
        </div>
      </div>
      <!-- TODO: It may be a good idea to break out these collapsable cards to be used elsewhere potentially -->
      <!-- TODO TODO: Yes please do this for notifications. Use prop to determine type -->
      <div class="card" v-for="(notification, index) in analyticsNotifications" :key="`analytics-notification-${index}`" style="margin-top: 20px;text-align: center;">
        <div class="card-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center" >
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            {{ notification.title }}
          </div>
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-left"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#analytics-notification-${index}`"
            />
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-down"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#analytics-notification-${index}`"
            />
          </div>
        </div>
        <div class="collapse collapse-analytics" :id="`analytics-notification-${index}`">
          <div class="card-body">
            <div class="row">
              <div class="col-2">
                Super cool analytics look :)
              </div>
              <div class="col">
                {{ notification.message }}
              </div>
              <div class="col-2">
                <button id="analytics-demo-signup" class="btn btn-success btn-sm" @click="startAnalyticsTrial()">
                  Start Free Trial
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" v-for="(notification, index) in systemNotifications" :key="index" style="margin-top: 20px;text-align: center;">
        <div class="card-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center" >
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            {{ notification.title }}
          </div>
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-left"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#system-notification-${index}`"
            />
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-down"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#system-notification-${index}`"
            />
          </div>
        </div>
        <div class="collapse collapse-system" :id="`system-notification-${index}`">
          <div class="card-body">
            <div class="row">
              <div class="col" style="max-width:500px;height:300px;">
              </div>
              <div class="col">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" v-for="(notification, index) in invoiceNotifications" :key="index" style="margin-top: 20px;text-align: center;">
        <div class="card-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center" >
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            {{ notification.title }}
          </div>
          <div class="mb-2 mb-md-0 flex-grow-1"></div>
          <div class="pr-5">
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-left"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#invoice-notification-${index}`"
            />
            <font-awesome-icon
              aria-expanded="false"
              id="status"
              icon="chevron-down"
              class="fa-w-16 fa-fw"
              type="button"
              data-toggle="collapse"
              :data-target="`#invoice-notification-${index}`"
            />
          </div>
        </div>
        <div class="collapse collapse-invoice" :id="`invoice-notification-${index}`">
          <div class="card-body">
            <div class="row">
              <div class="col" style="max-width:500px;height:300px;">
              </div>
              <div class="col">
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
    <template v-slot:footer>
      <button class="btn btn-xs btn-primary modal-default-button" style="max-height: 40px; width: 100px;" @click="toggleHideModal()">
        Close
      </button>
    </template>
  </BaseModal>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator'
import GistEmbed from '@/components/GistEmbed.vue'
import BaseModal from './BaseModal.vue'

/**
 * This component opens up a modal for picking from nested map points
 */

/**
 * TODO: Clean up template, separate base modal template into its own component to be used by map modal
 */

@Component({
  components: {
    BaseModal,
    GistEmbed
  }
})
export default class NotificationsModal extends Vue {
  $refs!: {
    baseModal: BaseModal;
  }

  // These are weird helper methods that act like inherited methods.
  // TODO: There may be a better way of doing inheritance with slots
  //       Would be better if component inherited from BaseModal and
  //       was still able to use slots and access parent functions
  public toggleShowModal () {
    this.$refs.baseModal.toggleShowModal()
  }

  public toggleHideModal () {
    this.$refs.baseModal.toggleHideModal()
  }

  public isVisible () {
    return this.$refs.baseModal.isVisible()
  }

  private analyticsNotifications: Array<any>
  private invoiceNotifications: Array<any>
  private systemNotifications: Array<any>
  private releaseNotesNotifications: Array<any>

  constructor () {
    super()
    this.analyticsNotifications = []
    this.invoiceNotifications = []
    this.systemNotifications = []
    this.releaseNotesNotifications = []
  }

  private created () {
    if ((this.$store.getters.isAdmin || this.$store.getters.isOwner) && this.$store.getters.isBuyer) {
      this.fetchNotifications()
    }
  }

  private fetchNotifications () {
    this.$apiService
      .fetchNotifications()
      .then((response: any) => {
        this.releaseNotesNotifications = response.release_notes_notifications || []
        this.analyticsNotifications = response.analytics_notifications || []
        this.invoiceNotifications = response.invoice_notifications || []
        this.systemNotifications = response.system_notifications || []
      })
      .catch((error: Error) => {
        console.log('Something went wrong fetching notifications')
        console.log(error)
      })
  }

  private startAnalyticsTrial () {
    this.$apiService
      .startAnalyticsTrial()
      .then(() => {
        return this.$authService.refreshToken()
      })
      .then(() => {
        this.$root.$emit('showAnalyticsTrialResponse')
        // TODO: Start a tour for analytics here?
        this.fetchNotifications()
      })
      .catch((error: Error) => {
        console.log('Something went wrong setting up analytics trial')
        console.log(error)
      })
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
  [aria-expanded=true].fa-chevron-left {
    display: none;
  }
  [aria-expanded=false].fa-chevron-down {
    display: none;
  }
  .fa-clipboard {
    font-size: 24px;
  }
  .fa-bell{
    font-size: 24px;
  }
  .fa-file-alt {
    font-size: 24px;
  }
  .fa-credit-card{
    font-size: 24px;
  }
  .custom-badge-all {
    background-color: white;
    border-style: solid;
    border-color: #009FDF;
    border-width: 2px;
    cursor: default;
  }
  .banner {
    width: 100%;
    height: 40px;
    font-size: 24px;
  }
  .banner-message {
    min-width: 300px;
    padding-left: 1rem;
  }
  .center-text {
    margin-top: .5rem;
  }
  .fixed-width {
    font-family: monospace;
    font-size: 120%;
  }
  div.table-no-top-line th {
    border-top: none !important;
  }
</style>
