
CREATE TABLE customers (
  customer_id integer generated by default as identity,
  customer_name varchar not null,
  customer_code varchar not null,
  live boolean not null default false,
  debug boolean not null default false,
  primary key (customer_id),
  constraint customer_code_constraint unique(customer_code)
);

CREATE TABLE route_shaders (
  route_shader_id integer generated by default as identity,
  route_shader_name varchar not null,
  ab_test boolean not null default false,
  acceptable_latency integer not null default 0,
  acceptable_packet_loss numeric not null default 0.0,
  packet_loss_sustained numeric not null default 0.0,
  analysis_only boolean not null default false,
  bandwidth_envelope_down_kbps integer not null default 1024,
  bandwidth_envelope_up_kbps integer not null default 1024,
  disable_network_next boolean not null default false,
  latency_threshold integer not null default 10,
  multipath boolean not null default true,
  reduce_latency boolean not null default true,
  reduce_packet_loss boolean not null default true,
  selection_percent integer not null default 100,
  max_latency_trade_off integer not null default 20,
  max_next_rtt integer not null default 300,
  route_switch_threshold integer not null default 10,
  route_select_threshold integer not null default 5,
  rtt_veto_default integer not null default 10,
  rtt_veto_multipath integer not null default 20,
  rtt_veto_packetloss integer not null default 30,
  force_next boolean not null default false,
  route_diversity int not null default 0,
  primary key (route_shader_id),
  constraint route_shader_short_name_constraint unique(route_shader_name)
);

CREATE TABLE buyers (
  buyer_id integer generated by default as identity,
  buyer_name varchar not null,
  public_key_base64 varchar not null,
  customer_id integer not null,
  route_shader_id integer not null,
  primary key (buyer_id),
  constraint fk_customer_id foreign key (customer_id) references customers(customer_id),
  constraint fk_route_shader_id foreign key (route_shader_id) references route_shaders(route_shader_id),
  constraint buyer_short_name_constraint unique(buyer_name)
);

CREATE TABLE sellers (
  seller_id integer generated by default as identity,
  seller_name varchar not null,
  customer_id integer,
  primary key (seller_id),
  constraint fk_customer_id foreign key (customer_id) references customers(customer_id),
  constraint seller_short_name_constraint unique(seller_name)
);

CREATE TABLE datacenters (
  datacenter_id integer generated by default as identity,
  datacenter_name varchar not null unique,
  native_name varchar not null default '',
  latitude numeric not null,
  longitude numeric not null,
  seller_id integer not null,
  notes varchar not null default '',
  primary key (datacenter_id),
  constraint fk_seller_id foreign key (seller_id) references sellers(seller_id),
  constraint datacenter_name_constraint unique(datacenter_name)
);

CREATE TABLE relays (
  relay_id integer generated by default as identity,
  relay_name varchar not null,
  datacenter_id integer not null,
  public_ip inet not null,
  public_port integer not null default 40000,
  internal_ip inet not null default '0.0.0.0',
  internal_port integer not null default 0,
  internal_group varchar not null default '',
  ssh_ip inet not null default '0.0.0.0',
  ssh_port integer not null default 22,
  ssh_user varchar not null default 'root',
  public_key_base64 varchar not null,
  private_key_base64 varchar not null default '',
  version varchar not null default '',
  mrc integer not null default 0,
  port_speed integer not null default 1000,
  max_sessions integer not null default 0,
  notes varchar not null default '',
  primary key (relay_id),
  constraint fk_datacenter foreign key (datacenter_id) references datacenters(datacenter_id),
  constraint relay_name_constraint unique(relay_name),
  constraint relay_public_ip_and_port_constraint unique(public_ip, public_port)
);

create table buyer_datacenter_settings (
  buyer_id integer not null,
  datacenter_id integer not null,
  enable_acceleration boolean not null default true,
  primary key (buyer_id, datacenter_id),
  constraint fk_buyer foreign key (buyer_id) references buyers(buyer_id),
  constraint fk_datacenter foreign key (datacenter_id) references datacenters(datacenter_id),
  constraint datacenter_map_unique_constraint unique(buyer_id, datacenter_id)
);
