# Relay Backend

The Relay Backend is responsible for:

1. Listening for new relays that come online and initialize them to be apart of set of available relays for routing
2. Accepting stat updates (RTT, Jitter, Packet Loss) from all relays and store their stats
3. Generate a cost then route matrix of optimized routes that are available which the Server Backend pulls a copy of
4. Keeps an updated relay location list using Redis to find nearby relays so the Server Backend can find relays near game clients

### Load & Scalability

Status: **LOW-MEDIUM**  
Scalability: **Vertically**

1. Relays send HTTP requests every 1 second
2. Computes the route matrix of all available routes every 10 seconds

### To Run

Run `make dev-relay-backend`

### Logging

Levels are cumulative so if you set `BACKEND_LOG_LEVEL=info` you will get `error` and `warn` too.

The default setting is `warn` when running `make dev-relay-backend` and `make dev-server-backend`. To override this you can set your own value by doing `make BACKEND_LOG_LEVEL=debug dev-relay-backend` and `make BACKEND_LOG_LEVEL=debug dev-server-backend`.

### Environment Variables

#### Required

- `BACKEND_LOG_LEVEL`: one of `none`, `error`, `warn`, `info`, `debug`
- `RELAY_ROUTER_PUBLIC_KEY`: the public key of the router
- `RELAY_ROUTER_PRIVATE_KEY`: the private key of the router
- `MAXMIND_DB_URI`: local path to a `.mmdb` file for IP lookups
- `RELAY_ROUTER_MAX_JITTER`: the maximum allowed jitter when generating a cost matrix. 10.0 is a good starting value
- `RELAY_ROUTER_MAX_PACKET_LOSS`: the maximum allowed packet loss when generating a cost matrix. 0.1 is a good starting value

#### Optional

- `GOOGLE_APPLICATION_CREDENTIALS`: Path to a .json file for the GCP credentials needed
- `GOOGLE_PROJECT_ID`: The Google project ID
- `RELAY_DEV`: enable development features, like what is listed below in the [important](#important) section
- `RELAY_STUBBED_DATA_FILENAME`: points to a json file that will be used to stub datacenter names and lat/long coords

#### IMPORTANT

If you do not set the `RELAY_MAXMIND_DB_URI` env var, you must have `RELAY_DEV` set (just exported or with a value, doesn't matter)

If you do have `RELAY_DEV` set, the backend will use a local json file to stub relay datacenter names & their latitude longitude coords.

The backend will parse the file `RELAY_STUBBED_DATA_FILENAME` points to. If the var is unset or empty, it will default to `tools/stubbed-relay-data.json`.

When using the default json file, only spawn relays with addresses & ports between the range 127.0.0.1:20000 & 127.0.0.10:20009, incrementing both the address and port at the same time, as those are the entries that exist in the file.

- Side note, the datacenter names & lat long coords were all autogenerated and thus the country state city matchup will not be accurate, nor will the lat long coords either for any of those fields.

### What it does

- Opens a couple endpoints for communication with the relays and server backend
- Takes data from the in memory StatsDatabase and generates a CostMatrix, then takes the CostMatrix and generates a RouteMatrix for the server backend once every 10 seconds

### Endpoints

- `/relay_init`: When a relay starts up, the first thing it will do is call this endpoint with its information
  - Gathers geolocation information
  - Generates the relay public keys, which is sent back in the body of the response
  - Stores the relay in redis in binary format
- `/relay_update`: After a relay has confirmation of successful initialization, it will keep sending this endpoint stats about its network timings
  - Within the response body will be a list of all other relays to ping and gather stats on
