MAKEFILE_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))

include $(MAKEFILE_DIR)/Makefile.common

############
### Vars ###
############

EXE										:= relay

LIB_OBJ_FILES					:= $(patsubst $(LIB)/%.cpp, $(OBJ)/$(LIB)/%.o, $(LIB_FILES))
LIB_DEP_FILES					:= $(patsubst $(LIB)/%.cpp, $(OBJ)/$(LIB)/%.d, $(LIB_FILES))

SRC_OBJ_FILES					:= $(patsubst $(SRC)/%.cpp, $(OBJ)/$(SRC)/%.o, $(SRC_FILES))
SRC_DEP_FILES					:= $(patsubst $(SRC)/%.cpp, $(OBJ)/$(SRC)/%.d, $(SRC_FILES))

COMMON_FLAGS 					:= $(CXX) $(CXX_FLAGS) $(CXX_PERF_FLAGS)
COMMON_COMPILE_FLAGS 	:= $(COMMON_FLAGS) -c -DNDEBUG

DIST_DIR							:= ../../dist

################
### Targets  ###
################

.PHONY: all
all: $(BIN)/$(EXE) $(DIST_DIR)/$(EXE)

.PHONY: run
run: $(BIN)/$(EXE)
	@$<

.PHONY: clean
clean:
	@rm -f $(BIN)/$(EXE) $(SRC_OBJ_FILES) $(SRC_DEP_FILES) $(LIB_OBJ_FILES) $(LIB_DEP_FILES) $(GCH)

##############
### Builds ###
##############

# precompiled header
$(GCH): $(PCH) Makefile
	$(COMMON_COMPILE_FLAGS) -o $@ $(INCLUDE_DIRS) -x c++-header $<

# all object files
$(OBJ)/%.o: %.cpp $(GCH)
	$(COMMON_COMPILE_FLAGS) -o $@ $(INCLUDE_DIRS) -MMD -MP $<

# the executable
$(BIN)/$(EXE): $(SRC_OBJ_FILES) $(LIB_OBJ_FILES)
	$(COMMON_FLAGS) -o $@ $^ $(LIBRARIES)

-include $(SRC_DEP_FILES) $(LIB_DEP_FILES)

####################
### Distribution ###
####################

# Have to copy twice.
# Both the reference and new build to dist/relay.
# For publishing to gcp there needs to be a
# difference so that it isn't overwritten by accident.
$(DIST_DIR)/$(EXE): $(BIN)/$(EXE)
	cp $< $@
	cp $< $(@)_new
